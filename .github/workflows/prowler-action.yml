name: Prowler New Scan

on:
  workflow_dispatch:

jobs:
  prowler-scan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: "us-east-1"
      ORG_MANAGEMENT_ACCOUNT_ID: ${{ secrets.ORG_MANAGEMENT_ACCOUNT_ID }}
      RESULTS_BUCKET: ${{ secrets.RESULTS_BUCKET }}
      ORG_ROLE_NAME: "ProwlerAuditRole"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get list of AWS accounts in the org
        run: |
          aws organizations list-accounts \
            --query "Accounts[?Status=='ACTIVE'].Id" \
            --output text | tr '\t' '\n' > accounts.txt

      - name: Install Prowler CLI
        run: |
          pip install prowler
          prowler -v

      - name: Run Prowler on each account
        run: |
          while IFS= read -r account_id; do
            account_id=$(echo "$account_id" | tr -d '\r' | xargs)
            echo "Scanning account: $account_id"

            creds=$(aws sts assume-role \
              --role-arn arn:aws:iam::$account_id:role/${ORG_ROLE_NAME} \
              --role-session-name prowler-session \
              --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
              --output text)

            export AWS_ACCESS_KEY_ID=$(echo $creds | awk '{print $1}')
            export AWS_SECRET_ACCESS_KEY=$(echo $creds | awk '{print $2}')
            export AWS_SESSION_TOKEN=$(echo $creds | awk '{print $3}')

            prowler -M csv,json,html -S -A $account_id -R $AWS_REGION \
              --bucket $RESULTS_BUCKET \
              --output-filename prowler-report-$account_id

          done < accounts.txt
